general:
    branches:
        only:
            - developing
        ignore:
            - master
            - /dev-.*/

machine:
    timezone:
        Europe/Berlin

    environment:
        GIT_AUTHOR_NAME: CircleCI
        GIT_AUTHOR_EMAIL: info@socialcars.org
        GIT_COMMITTER_NAME: CircleCI
        GIT_COMMITTER_EMAIL: info@socialcars.org

dependencies:
    cache_directories:
        - "/tmp/pandoc-citeproc/"

    pre:
        - sudo apt-get install zsh
        # see release version https://github.com/spf13/hugo/releases
        - wget -O hugo.deb https://github.com/spf13/hugo/releases/download/v0.21/hugo_0.21_Linux-64bit.deb
        - sudo dpkg -i hugo.deb
        # see release version https://github.com/yui/yuicompressor/releases
        - wget -O yuicompressor.jar https://github.com/yui/yuicompressor/releases/download/v2.4.8/yuicompressor-2.4.8.jar
        # see release version https://github.com/nodesource/distributions
        - "curl -sL https://deb.nodesource.com/setup_7.x | sudo -E bash"
        - sudo apt-get install -y nodejs
        # see release version https://www.npmjs.com/package/html-minifier-cli
        - npm install html-minifier -g
        # see release version https://www.npmjs.com/package/svgo
        - npm install svgo -g
        # install pandoc-citeproc from external share if not in /tmp, due to outdated containers *sigh*
        #- if [ ! -d /tmp/pandoc-citeproc/ ]; then curl -L https://tesseract.in.tu-clausthal.de:8443/index.php/s/YIqE0QBgqu8YZuK/download | tar xJp --strip 1 -C /tmp; fi
        
test:
    override:
        - git submodule init
        - git submodule update
        # build references if static/references.bib exists
        #- if [ -f static/references.bib ]; then /tmp/pandoc-citeproc/pandoc-citeproc --bib2json static/references.bib > data/references.json; fi
        - hugo --ignoreCache --cleanDestinationDir
        - find public -type f -name "*.css" -exec java -jar yuicompressor.jar -o \{\} \{\} \;
        - find public -type f -name "*.js" -exec java -jar yuicompressor.jar -o \{\} \{\} \;
        - find public -type f -name "*.htm*" -exec sh data/minifyhtml.sh \{\} \;
        - find public -type f -name "*.svg" -and -not -name "*.nosvgo.svg" -exec svgo \{\} \;
        - mv -f public /tmp

deployment:
    production:
        branch: developing
        commands:
            - git push origin :master || true
            - git branch -D master || true
            - git checkout --orphan master
            - rm -Rf *
            - mv -f /tmp/public/* .
            - echo -e 'general:\n    branches:\n        ignore:\n            - master\n' > circle.yml
            - echo -e '*.*\n!.gitignore\n!circle.yml\n!readme.md\n!*.html\n!*.xml\n!*.css\n!*.js\n!*.json\n!*.bib\n!*.zip\n!*.png\n!*.jpg\n!*.jpeg\n!*.gif\n!*.pdf\n!*.svg\n!*.txt\n!*.ttf\n!*.ico\n' > .gitignore
            - echo -e '# Social Cars Project Website\n\n* This is the deploy branch for [https://socialcars.github.io](https://socialcars.github.io).\n* The website is deployed by [Hugo](https://gohugo.io) with [CirceCI](https://circleci.com).\n* **Important:** DO NOT push changes into this branch! Only push changes to the `developing` branch. Changes pushed to the `master` branch will be overwritten when CircleCI re-deploys the website.' > readme.md
            - git add --all .
            - export GIT_COMMIT_MESSAGE="$(git show -s --pretty=format:%s $CIRCLE_SHA1)" && git commit -m "webpage update [$GIT_COMMIT_MESSAGE]"
            - git push origin master
